#include <stdio.h>
#include <math.h>
#include <time.h>
#include "utils.h"
#include "PSOLA.h"
#include "arrays_psola.h"
#include "pitch_detection.h"
#include "FLWT.h"
 
#define WINDOWLEN	512

int16_t test[1024] = {0,19,37,54,68,81,90,97,100,99,95,88,77,64,48,31,13,-6,-25,-43,-59,-73,-84,-93,-98,-100,-98,-93,-84,-73,-59,-43,-25,-6,13,31,48,64,77,88,95,99,100,97,90,81,68,54,37,19,0,-19,-37,-54,-68,-81,-90,-97,-100,-99,-95,-88,-77,-64,-48,-31,-13,6,25,43,59,73,84,93,98,100,98,93,84,73,59,43,25,6,-13,-31,-48,-64,-77,-88,-95,-99,-100,-97,-90,-81,-68,-54,-37,-19,0,19,37,54,68,81,90,97,100,99,95,88,77,64,48,31,13,-6,-25,-43,-59,-73,-84,-93,-98,-100,-98,-93,-84,-73,-59,-43,-25,-6,13,31,48,64,77,88,95,99,100,97,90,81,68,54,37,19,0,-19,-37,-54,-68,-81,-90,-97,-100,-99,-95,-88,-77,-64,-48,-31,-13,6,25,43,59,73,84,93,98,100,98,93,84,73,59,43,25,6,-13,-31,-48,-64,-77,-88,-95,-99,-100,-97,-90,-81,-68,-54,-37,-19,0,19,37,54,68,81,90,97,100,99,95,88,77,64,48,31,13,-6,-25,-43,-59,-73,-84,-93,-98,-100,-98,-93,-84,-73,-59,-43,-25,-6,13,31,48,64,77,88,95,99,100,97,90,81,68,54,37,19,0,-19,-37,-54,-68,-81,-90,-97,-100,-99,-95,-88,-77,-64,-48,-31,-13,6,25,43,59,73,84,93,98,100,98,93,84,73,59,43,25,6,-13,-31,-48,-64,-77,-88,-95,-99,-100,-97,-90,-81,-68,-54,-37,-19,0,19,37,54,68,81,90,97,100,99,95,88,77,64,48,31,13,-6,-25,-43,-59,-73,-84,-93,-98,-100,-98,-93,-84,-73,-59,-43,-25,-6,13,31,48,64,77,88,95,99,100,97,90,81,68,54,37,19,0,-19,-37,-54,-68,-81,-90,-97,-100,-99,-95,-88,-77,-64,-48,-31,-13,6,25,43,59,73,84,93,98,100,98,93,84,73,59,43,25,6,-13,-31,-48,-64,-77,-88,-95,-99,-100,-97,-90,-81,-68,-54,-37,-19,0,19,37,54,68,81,90,97,100,99,95,88,77,64,48,31,13,-6,-25,-43,-59,-73,-84,-93,-98,-100,-98,-93,-84,-73,-59,-43,-25,-6,13,31,48,64,77,88,95,99,100,97,90,81,68,54,37,19,0,-19,-37,-54,-68,-81,-90,-97,-100,-99,-95,-88,-77,-64,-48,-31,-13,6,25,43,59,73,84,93,98,100,98,93,84,73,59,43,25,6,-13,-31,-48,-64,-77,-88,-95,-99,-100,-97,-90,-81,-68,-54,-37,-19,0,19,37,54,68,81,90,97,100,99,95,88,77,64,48,31,13,-6,-25,-43,-59,-73,-84,-93,-98,-100,-98,-93,-84,-73,-59,-43,-25,-6,13,31,48,64,77,88,95,99,100,97,90,81,68,54,37,19,0,-19,-37,-54,-68,-81,-90,-97,-100,-99,-95,-88,-77,-64,-48,-31,-13,6,25,43,59,73,84,93,98,100,98,93,84,73,59,43,25,6,-13,-31,-48,-64,-77,-88,-95,-99,-100,-97,-90,-81,-68,-54,-37,-19,0,19,37,54,68,81,90,97,100,99,95,88,77,64,48,31,13,-6,-25,-43,-59,-73,-84,-93,-98,-100,-98,-93,-84,-73,-59,-43,-25,-6,13,31,48,64,77,88,95,99,100,97,90,81,68,54,37,19,0,-19,-37,-54,-68,-81,-90,-97,-100,-99,-95,-88,-77,-64,-48,-31,-13,6,25,43,59,73,84,93,98,100,98,93,84,73,59,43,25,6,-13,-31,-48,-64,-77,-88,-95,-99,-100,-97,-90,-81,-68,-54,-37,-19,0,19,37,54,68,81,90,97,100,99,95,88,77,64,48,31,13,-6,-25,-43,-59,-73,-84,-93,-98,-100,-98,-93,-84,-73,-59,-43,-25,-6,13,31,48,64,77,88,95,99,100,97,90,81,68,54,37,19,0,-19,-37,-54,-68,-81,-90,-97,-100,-99,-95,-88,-77,-64,-48,-31,-13,6,25,43,59,73,84,93,98,100,98,93,84,73,59,43,25,6,-13,-31,-48,-64,-77,-88,-95,-99,-100,-97,-90,-81,-68,-54,-37,-19,0,19,37,54,68,81,90,97,100,99,95,88,77,64,48,31,13,-6,-25,-43,-59,-73,-84,-93,-98,-100,-98,-93,-84,-73,-59,-43,-25,-6,13,31,48,64,77,88,95,99,100,97,90,81,68,54,37,19,0,-19,-37,-54,-68,-81,-90,-97,-100,-99,-95,-88,-77,-64,-48,-31,-13,6,25,43,59,73,84,93,98,100,98,93,84,73,59,43,25,6,-13,-31,-48,-64,-77,-88,-95,-99,-100,-97,-90,-81,-68,-54,-37,-19,0,19,37,54,68,81,90,97,100,99,95,88,77,64,48,31,13,-6,-25,-43,-59,-73,-84,-93,-98,-100,-98,-93,-84,-73,-59,-43,-25,-6,13,31,48,64,77,88,95,99,100,97,90,81,68,54,37,19,0,-19,-37,-54,-68,-81,-90,-97,-100,-99,-95,-88,-77,-64,-48,-31,-13,6,25,43,59,73,84,93,98,100,98,93,84,73,59,43,25,6,-13,-31,-48,-64,-77,-88,-95,-99,-100,-97,-90,-81,-68,-54,-37,-19,0,19,37,54,68,81,90,97,100,99,95,88,77,64,48,31,13,-6,-25,-43,-59,-73,-84,-93};
int16_t autocorre[1024];
int16_t peaks[1024];

int main(void)
{
//    rt_buffer rt_input;     // Este hay que asociarlo con el ADC, es lo que procesa PSOLA
//    rt_buffer rt_output;    // Este hay que asociarlo con el DAC, es la salida de PSOLA
	
    float fs = 66666.66666666667f;
    //float pitch = 1000.0f;
    //float desiredPitch = 2000.0f;
//    float detected_pitch = 0.0f; 
//    uint16_t levels = 6;

//    initPSOLA(&psola, WINDOWLEN);
//    initFLWT(&flwt, levels, WINDOWLEN);

    printf("PSOLA Testing\n");
    
    auto_correlation(test, 1024, autocorre);
    //Ver resultad autocorrecion
			

    
//    for (uint16_t i = 0; i < 3; i++) 
//    {
        //detected_pitch = getPitch(&flwt, test2 + i*WINDOWLEN, WINDOWLEN, fs);
        //pitchCorrect(&psola, test2 + i*WINDOWLEN, fs, detected_pitch, 1.5 * detected_pitch);
        //detected_pitch = getPitch(&flwt, psola.debugging, psola.num_samp_working, fs);
        //printf("Detected Pitch of PSOLA result = %f\n", detected_pitch);
//    }
    uint16_t peaks_len;
    
    peaks_len = find_peaks(test, 1024, peaks , fs);
    float detected_pitch = get_fundamental(peaks, 1024, fs);
    printf("Detected Pitch of windows = %f \n", detected_pitch); 
    printf("/n");
    return 0;
}
